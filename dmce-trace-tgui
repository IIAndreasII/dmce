#!/usr/bin/python3

import curses
import argparse
import os
import sys
import re
from curses import wrapper

parser = argparse.ArgumentParser(description='{}'.format(os.path.basename(__file__)))
parser.add_argument('tfile',            type=str,                   help='Trace file (output from dmce-trace)')
args = parser.parse_args()

wx_traceview = 0
wy_traceview = 0
wx_codeview = 0
wy_codeview = 40
wx_varsview = 100
wy_varsview = 40

num_srclines = 30
num_tracelines = 30

h_screen = 0
w_screen = 0

tracebuffer = []
full_tracebuffer = []
codebuffer = []
varbuffer = []
numbuffer = []
cmdbuffer = []
cmdhistory = [[]]
cmdhistoryindex = 0
jumplist = []
jumpindex = 0
cmd_error_code = ""

core_filter = []

last_search_cmd = ""
search_dir = "down"
tv_start = 0
tv_end = 0
src_start = 0
src_end = 0
index = 0
srcindex = 0
old_srcpath = ""

#log = open("/tmp/dmcetraceviewer.log", "w")


user_input_mode = False

def init(stdscr):
    global tracebuffer
    global full_tracebuffer
    global args

    global wy_codeview
    global wy_varsview
    global wx_varsview
    global num_srclines
    global num_tracelines
    global w_screen
    global h_screen

    h_screen, w_screen = stdscr.getmaxyx()
    wy_codeview = wy_varsview = int(h_screen / 2)
    num_srclines = num_tracelines = int((h_screen / 2) - 3)

    wx_varsview = w_screen - int(w_screen / 4)

    tf = open(args.tfile)
    full_tracebuffer = tf.readlines()
    tf.close()

    i = 0
    while i < len(full_tracebuffer):
        full_tracebuffer[i] = str(i) + "@" + full_tracebuffer[i]
        i += 1

    tracebuffer = full_tracebuffer.copy()

#    print("dmce trace viewer log", file=log)

def draw(stdscr):
    global tracebuffer
    global varbuffer
    global codebuffer
    global index
    global tv_start
    global tv_end
    global src_start
    global src_end
    global num_srclines
    global num_tracelines
    global old_srcpath

# trace view
    for i in range(tv_start, tv_end + 1):
        if i < len(tracebuffer):
            lout = tracebuffer[i].rstrip().split("@")
            pre = " "
            if tracebuffer[i].split("@")[0] in jumplist:
                pre = ">"
            tout = pre + '@'.join(lout[0:7]).replace("@", " ")
            wtout = w_screen - (w_screen - wx_varsview) - 1
            tout = tout[:wtout].ljust(wtout, " ")
            if i == index:
                stdscr.addstr(wy_traceview + i - tv_start, wx_traceview, tout, curses.A_REVERSE)
            else:
                stdscr.addstr(wy_traceview + i - tv_start, wx_traceview, tout)
        else:
            stdscr.hline(wy_traceview + i - tv_start, wx_traceview, ' ', wtout)


# code view
    srcpath = tracebuffer[index].split("@")[3]

    sf = open(srcpath)
    codebuffer = sf.readlines()
    sf.close()
    srcindex = int(tracebuffer[index].split("@")[4]) - 1

    if old_srcpath != srcpath:
        src_start = srcindex - int(num_srclines / 2)
        old_srcpath = srcpath

    if src_start > srcindex:
        src_start = srcindex - int(num_srclines / 2)

    if srcindex > (src_start + num_srclines - 1):
        src_start = srcindex - int(num_srclines / 2) + 1

    for i in range(num_srclines):
        if (src_start + i) < len(codebuffer):
            if (src_start + i) == srcindex:
                stdscr.addstr(wy_codeview + i, wx_codeview, codebuffer[src_start + i], curses.A_REVERSE)
            else:
                stdscr.addstr(wy_codeview + i, wx_codeview, codebuffer[src_start + i])
        else:
            stdscr.addstr(wy_codeview + i, wx_codeview, "                                                                           ")
#        stdscr.addstr(wy_codeview, 40, "start: " + str(src_start) + "index: " + str(srcindex) + " h: " + str(h_screen) + " w: " + str(w_screen), curses.A_REVERSE)

# vars view
    varstr = tracebuffer[index].split("@")[7:]
    vout = varstr[0].split(" ")
    i = 0
    for v in vout:
        stdscr.addstr(wy_varsview + i, wx_varsview, v)
        i += 1
    for j in range(5-i):
        stdscr.addstr(wy_varsview + i + j, wx_varsview, "                                           ")

# trace info view
    entry_num = tracebuffer[index].split("@")[0]
    filename = os.path.basename(srcpath)
    core = tracebuffer[index].split("@")[1]
    timestamp = float(tracebuffer[index].split("@")[2])
    if index > 0:
        timestamp_prev = float(tracebuffer[index - 1].split("@")[2])
    else:
        timestamp_prev = 0
    diff = int(timestamp - timestamp_prev)
    timestamp = int(timestamp)
    function = tracebuffer[index].split("@")[5]

#    stdscr.addstr(0, wx_varsview, "".ljust(w_screen - wx_varsview, " "))
    stdscr.addstr(1, wx_varsview, (" Trace entry      : " + entry_num + " / " + str(len(tracebuffer))).ljust(w_screen - wx_varsview, " "))
    stdscr.addstr(2, wx_varsview, (" File             : " + filename).ljust(w_screen - wx_varsview, " "))
    stdscr.addstr(3, wx_varsview, (" Function         : " + function).ljust(w_screen - wx_varsview, " "))
    stdscr.addstr(4, wx_varsview, (" Core             : " + core).ljust(w_screen - wx_varsview, " "))
    stdscr.addstr(5, wx_varsview, (" Timestamp        : " + str(timestamp)).ljust(w_screen - wx_varsview, " "))
    stdscr.addstr(6, wx_varsview, (" Timestamp prev   : " + str(int(timestamp_prev))).ljust(w_screen - wx_varsview, " "))
    stdscr.addstr(7, wx_varsview, (" Diff             : " + str(diff)).ljust(w_screen - wx_varsview, " "))
    stdscr.addstr(8, wx_varsview, (" Filters"))
    stdscr.addstr(9, wx_varsview, (" ---------------------"))
    stdscr.addstr(10, wx_varsview, (" Cores: " + ", ".join(core_filter)).ljust(w_screen - wx_varsview, " "))
    stdscr.addstr(12, wx_varsview, (" Markers: " + ", ".join(jumplist)).ljust(w_screen - wx_varsview, " "))

# cmd view
    if user_input_mode:
        cmdstr = "".join(cmdbuffer)
        stdscr.addstr(wy_codeview + num_srclines + 1, 0, ":" + cmdstr.ljust(w_screen - (w_screen - wx_varsview), " "))
    else:
        stdscr.hline(wy_codeview + num_srclines + 1, wx_codeview, ' ', w_screen - wx_varsview - 1)

# info / error codes
    stdscr.addstr(wy_codeview + num_srclines + 1, wx_varsview, cmd_error_code.ljust(w_screen - wx_varsview, " "), curses.A_BLINK)

# bars
    stdscr.hline(wy_codeview - 2, wx_codeview, '_', w_screen)
    stdscr.hline(wy_codeview + num_srclines, wx_codeview, '_', w_screen)
    stdscr.vline(0, wx_varsview - 1, '|', h_screen)


def cleanup_exit():
    curses.nocbreak()
    stdscr.keypad(0)
    curses.echo()
    curses.endwin()

def goto_index(istr):
    global index
    global tracebuffer

    # interval halving later if needed!
    i = 0
    while i < len(tracebuffer):
        if (istr == tracebuffer[i].split("@")[0]):
            index = i
            return
        i += 1
    index = 0

def clear_core_filter():
    global cmd_error_code
    global core_filter
    global tracebuffer
    global full_tracebuffer
    global index

    core_filter = []
    cur_index = tracebuffer[index].split("@")[0]
    tracebuffer = full_tracebuffer.copy()
    goto_index(cur_index)
    cmd_error_code = "Core filter reset"

def filter_cores(cores):
    global cmd_error_code
    global core_filter
    global tracebuffer
    global full_tracebuffer
    global index

    if cores == "clear":
        clear_core_filter()
        return
    else:
        temp = []
        for c in cores.split(","):
            c = c.strip()
            if c.isdigit():
                temp.append(c)
            else:
                cmd_error_code = "'filter cores' needs a comma separated list of cores or 'clear'"
                return

        core_filter = temp
        f = "|".join(core_filter)
        sr = '^\d*@(' + f + ')@.*'
        re_core = re.compile(sr)
        cur_index = tracebuffer[index].split("@")[0]
        tracebuffer = list(filter(lambda tline: re_core.match(tline), full_tracebuffer))
        goto_index(cur_index)
        return

def clear_all_filters():
    clear_core_filter()
    return

def cmd_filter(cmds):
    global cmd_error_code
    if len(cmds) >= 2:
        if cmds[1] == "core":
            if len(cmds) >= 3:
                filter_cores(cmds[2])
                return
        elif cmds[1] == "clear":
            clear_all_filters()
            return
    cmd_error_code = "Bad filter: '" + " ".join(cmds[1:]) + "'"
    return

def cmd_search(sstr):
    global cmd_error_code
    global last_search_cmd
    global tracebuffer
    global index
    global search_dir

    if len(sstr) > 1:
        if sstr[:2] == "/'":
            r = re.compile(sstr[2:])
            if search_dir == "down":
                i = index + 1
                while i < len(tracebuffer):
                    if r.search(tracebuffer[i]):
                        nbr_te = tracebuffer[i].split("@")[0]
                        cmd_error_code = "Found '" + sstr[1:] + "' at trace entry: " + nbr_te
                        index = i
                        last_search_cmd = sstr
                        return
                    i += 1
            else:
                i = index - 1
                while i > 0:
                    if r.search(tracebuffer[i]):
                        nbr_te = tracebuffer[i].split("@")[0]
                        cmd_error_code = "Found '" + sstr[1:] + "' at trace entry: " + nbr_te
                        index = i
                        last_search_cmd = sstr
                        return
                    i -= 1
        else:
            if search_dir == "down":
                i = index + 1
                while i < len(tracebuffer):
                    if sstr[1:] in tracebuffer[i]:
                        nbr_te = tracebuffer[i].split("@")[0]
                        cmd_error_code = "Found '" + sstr[1:] + "' at trace entry: " + nbr_te
                        index = i
                        last_search_cmd = sstr
                        return
                    i += 1
            else:
                i = index - 1
                while i > 0:
                    if sstr[1:] in tracebuffer[i]:
                        nbr_te = tracebuffer[i].split("@")[0]
                        cmd_error_code = "Found '" + sstr[1:] + "' at trace entry: " + nbr_te
                        index = i
                        last_search_cmd = sstr
                        return
                    i -= 1

        cmd_error_code = "Not found: " + sstr[1:]
        return
    else:
        cmd_error_code = "Empty search string!"
        return

def execute_command(cmdstr):
    global cmd_error_code

    if len(cmdstr) == 0:
        return

    if cmdstr[0] == "/":
        cmd_search(cmdstr)
        return

    cmds  = cmdstr.split(" ")

    if cmds[0] == "filter":
        cmd_filter(cmds)
        return

    cmd_error_code = "Command not recognized: '" + cmdstr + "'"
    return

def show_help(stdscr):
    stdscr.clear()
    stdscr.addstr(0, 0,  "  Keys")
    stdscr.addstr(1, 0,  "  ---------------------------------------------------------")
    stdscr.addstr(2, 0,  "  q             - quit")
    stdscr.addstr(3, 0,  "  arrow up      - move upwards")
    stdscr.addstr(4, 0,  "  arrow down    - move downwards")
    stdscr.addstr(5, 0,  "  page up       - move one page up")
    stdscr.addstr(6, 0,  "  page up       - move one page up")
    stdscr.addstr(7, 0,  "  :             - Enter command mode")
    stdscr.addstr(8, 0,  "  /             - Enter command mode and search")
    stdscr.addstr(9, 0,  "  n             - search downwards")
    stdscr.addstr(10, 0, "  N             - search upwards")
    stdscr.addstr(11, 0, "  g             - move to the top")
    stdscr.addstr(12, 0, "  G             - move to the bottom")
    stdscr.addstr(13, 0, "  [digits]g     - move to trace entry with index [digits]")
    stdscr.addstr(14, 0, "  s             - add trace entry to jump list (markers)")
    stdscr.addstr(15, 0, "  j             - jump to next marker")
    stdscr.addstr(16, 0, "  J             - jump to previous marker")
    stdscr.addstr(20, 0, "  Commands")
    stdscr.addstr(21, 0, "  ---------------------------------------------------------")
    stdscr.addstr(22, 0, "  filter core A,B,C     - filter on core number")
    stdscr.addstr(23, 0, "  filter core clear     - clear core filter")
    stdscr.addstr(23, 0, "  filter clear          - clear all filters")
    stdscr.addstr(27, 0, "  Hints")
    stdscr.addstr(28, 0, "  ---------------------------------------------------------------------")
    stdscr.addstr(29, 0, "  - In command mode, any string prepended by '/' will be searched for)")
    stdscr.addstr(30, 0, "  - Python regular expressions can be used for searches using a ' sign")
    stdscr.addstr(31, 0, "    Example: :/'.*foo.*bar")

    c = stdscr.getch()

def jump(direction):
    global jumplist
    global jumpindex
    global tracebuffer
    global cmd_error_code
    global index

    if len(jumplist) > 0:
        if direction == "forward":
            jumpindex += 1
            if jumpindex >= len(jumplist):
                jumpindex = 0
        else:
            jumpindex -= 1
            if jumpindex < 0:
                jumpindex = len(jumplist) - 1

        # Replace linear search with interval halving later if needed...

        i = 0
        ejump = jumplist[jumpindex]
        found = False
        while i < len(tracebuffer):
            if tracebuffer[i].split("@")[0] == ejump:
                index = i
                found  = True
                break
            i += 1
        if not found:
            cmd_error_code = "Marker '" + ejump + "' not available in this filter view"
    else:
        cmd_error_code = "No markers set!"

def set_marker():
    global jumpindex
    global jumplist

    curindex = tracebuffer[index].split("@")[0]
    # unset?
    if curindex in jumplist:
        jumplist.remove(curindex)
        return

    jumpindex = len(jumplist)
    jumplist.append(curindex)

def clear_jumplist():
    global jumpindex
    global jumplist

    jumpindex = 0
    jumplist = []

def main(stdscr):
    global cmd_error_code
    global tracebuffer
    global numbuffer
    global cmdbuffer
    global cmdhistory
    global cmdhistoryindex
    global index
    global tv_start
    global tv_end
    global user_input_mode
    global search_dir
    init(stdscr)


    index = len(tracebuffer) - 1
    c = ord('z')

    while 1:
        if user_input_mode:
            search_dir = "down"
            if c == curses.KEY_ENTER or c == 10 or c == 13:
                if len(cmdbuffer) > 0:
                    cmdhistory.insert(1,cmdbuffer.copy())
                    cmdhistoryindex = 0
                    execute_command("".join(cmdbuffer))
                    cmdbuffer = []
                user_input_mode = False
            elif len(cmdbuffer) > 0 and c == curses.KEY_BACKSPACE:
                cmdbuffer.pop()
            elif c >= 32 and c <= 126:
                cmdbuffer.append(chr(c))
            elif c == curses.KEY_DOWN:
                cmdhistoryindex -= 1
                if cmdhistoryindex < 0:
                    cmdhistoryindex = len(cmdhistory) - 1
                cmdbuffer = cmdhistory[cmdhistoryindex].copy()
            elif c == curses.KEY_UP:
                cmdhistoryindex += 1
                if cmdhistoryindex > len(cmdhistory) - 1:
                    cmdhistoryindex = 0
                cmdbuffer = cmdhistory[cmdhistoryindex].copy()
        else:
            if c == ord('h'):
                show_help(stdscr)
            if c == ord('q'):
                break
            elif c == ord(':'):
                user_input_mode = True
            elif c == ord('/'):
                user_input_mode = True
                cmdbuffer = ['/']
            elif c == ord('g'):
                if len(numbuffer) > 0:
                    ijump = 0
                    dec = 1
                    for n in reversed(numbuffer):
                        ijump += dec * n
                        dec = dec * 10
                    index = ijump
                    if index < 0:
                        index = 0
                    if index > (len(tracebuffer) - 1):
                        index = len(tracebuffer) - 1
                    numbuffer = []
                else:
                    index = 0

                old_srcpath = ""
            elif c == ord('G'):
                index = len(tracebuffer) - 1
            elif c == ord('n'):
                search_dir = "down"
                execute_command(last_search_cmd)
                cmdbuffer = []
                user_input_mode = False
            elif c == ord('N'):
                search_dir = "up"
                execute_command(last_search_cmd)
                cmdbuffer = []
                user_input_mode = False
            elif c == curses.KEY_UP:
                if index > 0:
                    index -= 1
            elif c == curses.KEY_DOWN:
                if index < len(tracebuffer) - 1:
                    index += 1
            elif c == curses.KEY_PPAGE:
                index -= num_tracelines
                if index < 0:
                    index = 0
            elif c == curses.KEY_NPAGE:
                index += num_tracelines
                if index > (len(tracebuffer) - 1):
                    index = len(tracebuffer) - 1
            elif c == ord('s'):
                set_marker()
            elif c == ord('c'):
                clear_jumplist()
            elif c == ord('j'):
                jump("forward")
            elif c == ord('J'):
                jump("back")
            elif c >= ord('0') and c <= ord('9'):
                numbuffer.append(int(c - ord('0')))

        if index < tv_start:
            tv_start = index
        if index >= tv_end:
            tv_start = index - num_tracelines

        tv_end = tv_start + num_tracelines

        draw(stdscr)
#        stdscr.addstr(50, 0, "DEBUG")
        c = stdscr.getch()

wrapper(main)



# EOF
